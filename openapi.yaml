openapi: 3.0.3
info:
  title: Down Dirty 84 AI Tuning MVP API
  version: 0.3.0
servers:
- url: http://localhost:8080
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required:
                - ok
  /api/v1/brand/profile:
    get:
      summary: Get brand profile
      responses:
        '200':
          description: Brand profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrandProfile'
  /api/v1/jobs/{jobId}/analyze:
    post:
      summary: Start analysis for one or more uploaded logs
      parameters:
      - in: path
        name: jobId
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalyzeRequest'
      responses:
        '202':
          description: Queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyzeQueued'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/runs/{runId}:
    get:
      summary: Get run status
      parameters:
      - in: path
        name: runId
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/jobs/{jobId}/validation:
    get:
      summary: Get validation result for a job run
      parameters:
      - in: path
        name: jobId
        required: true
        schema:
          type: string
          format: uuid
      - in: query
        name: runId
        required: false
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Validation object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Validation'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/jobs/{jobId}/findings:
    get:
      summary: Get findings for a job run
      parameters:
      - in: path
        name: jobId
        required: true
        schema:
          type: string
          format: uuid
      - in: query
        name: runId
        required: false
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Findings object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Findings'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/jobs/{jobId}/diffsets/generate:
    post:
      summary: Generate a diffset for a job run
      parameters:
      - in: path
        name: jobId
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiffSetGenerateRequest'
      responses:
        '200':
          description: DiffSet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiffSet'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/jobs/{jobId}/diffsets:
    get:
      summary: List diffsets for a job run
      parameters:
      - in: path
        name: jobId
        required: true
        schema:
          type: string
          format: uuid
      - in: query
        name: runId
        required: false
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: DiffSet summaries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DiffSetSummary'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/diffsets/{diffSetId}:
    get:
      summary: Get diffset by ID
      parameters:
      - in: path
        name: diffSetId
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: DiffSet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiffSet'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/diffsets/{diffSetId}/export/summary:
    post:
      summary: Export branded summary text for diffset
      parameters:
      - in: path
        name: diffSetId
        required: true
        schema:
          type: string
          format: uuid
      responses:
        '200':
          description: Summary text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportSummaryResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/diffsets/{diffSetId}/export/csv:
    post:
      summary: Export CSV changelist for diffset
      parameters:
      - in: path
        name: diffSetId
        required: true
        schema:
          type: string
          format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportCsvRequest'
      responses:
        '200':
          description: CSV
          content:
            text/csv:
              schema:
                type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/auth/start:
    post:
      summary: Start magic link login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthStartRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStartResponse'
  /api/v1/auth/verify:
    post:
      summary: Verify magic link token and create session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthVerifyRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthVerifyResponse'
        '401':
          description: Unauthorized
  /api/v1/auth/logout:
    post:
      summary: Logout
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStartResponse'
  /api/v1/me:
    get:
      summary: Get current user
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
  /api/v1/jobs:
    get:
      summary: List jobs
      responses:
        '200':
          description: OK
    post:
      summary: Create job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
      responses:
        '201':
          description: Created
  /api/v1/jobs/{jobId}:
    get:
      summary: Get job
      parameters:
      - name: jobId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
        '404':
          description: Not found
  /api/v1/uploads:
    post:
      summary: Upload file (multipart)
      responses:
        '200':
          description: OK
  /api/v1/uploads/jobs/{jobId}:
    get:
      summary: List uploads for job
      parameters:
      - name: jobId
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
  /api/v1/admin/jobs:
    get:
      summary: Admin list jobs
      responses:
        '200':
          description: OK
        '403':
          description: Forbidden
  /api/v1/admin/jobs/{jobId}:
    get:
      summary: Admin get job
      responses:
        '200':
          description: OK
        '403':
          description: Forbidden
    patch:
      summary: Admin update job
      responses:
        '200':
          description: OK
        '403':
          description: Forbidden
  /api/v1/stripe/webhook:
    post:
      summary: Stripe webhook
      responses:
        '200':
          description: OK
components:
  schemas:
    ErrorResponse:
      type: object
      required:
      - error
      - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
    BrandProfile:
      type: object
      required:
      - brandName
      - website
      - supportEmail
      - reportTitleTemplate
      - disclaimer
      properties:
        brandName:
          type: string
        website:
          type: string
        supportEmail:
          type: string
        reportTitleTemplate:
          type: string
        watermarkText:
          type:
          - string
          - 'null'
        logoAssetId:
          type:
          - string
          - 'null'
        accentColor:
          type:
          - string
          - 'null'
        disclaimer:
          type: object
          required:
          - short
          - full
          properties:
            short:
              type: string
            full:
              type: string
    AnalyzeRequest:
      type: object
      required:
      - logUploadIds
      properties:
        logUploadIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
        hints:
          type: object
          additionalProperties: true
    AnalyzeQueued:
      type: object
      required:
      - runId
      - status
      properties:
        runId:
          type: string
          format: uuid
        status:
          type: string
          enum:
          - QUEUED
    RunStatus:
      type: object
      required:
      - runId
      - status
      - progress
      - errors
      properties:
        runId:
          type: string
          format: uuid
        status:
          type: string
          enum:
          - QUEUED
          - RUNNING
          - SUCCEEDED
          - FAILED
          - CANCELED
        progress:
          type: object
          required:
          - pct
          - stage
          properties:
            pct:
              type: number
            stage:
              type: string
        startedAt:
          type:
          - string
          - 'null'
          format: date-time
        finishedAt:
          type:
          - string
          - 'null'
          format: date-time
        errors:
          type: array
          items:
            type: object
            required:
            - code
            - message
            properties:
              code:
                type: string
              message:
                type: string
              details:
                type: object
                additionalProperties: true
    NextLogPlan:
      type: object
      required:
      - planId
      - title
      - routine
      - safetyNotes
      - recommendedLogPreset
      properties:
        planId:
          type: string
        title:
          type: string
        bullets:
          type: array
          items:
            type: object
            required:
            - kind
            - text
            properties:
              kind:
                type: string
              text:
                type: string
        routine:
          type: array
          items:
            type: string
        safetyNotes:
          type: array
          items:
            type: string
        recommendedLogPreset:
          type: string
    Validation:
      type: object
      required:
      - status
      - wbStatus
      - missingChannels
      - recommendedLogPreset
      - nextLogPlan
      properties:
        status:
          type: string
          enum:
          - PASS
          - FAIL
        wbStatus:
          type: string
        missingChannels:
          type: array
          items:
            type: string
        vehicleProfileDetected:
          type: object
          additionalProperties: true
        recommendedLogPreset:
          type: string
        nextLogPlan:
          $ref: '#/components/schemas/NextLogPlan'
    Findings:
      type: object
      required:
      - summary
      - items
      - chartSpecs
      properties:
        summary:
          type: object
          required:
          - blockers
          - warnings
          - info
          properties:
            blockers:
              type: integer
            warnings:
              type: integer
            info:
              type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/FindingItem'
        chartSpecs:
          type: array
          items:
            type: object
            additionalProperties: true
    FindingItem:
      type: object
      required:
      - id
      - severity
      - code
      - title
      - summary
      - evidence
      - actions
      properties:
        id:
          type: string
        severity:
          type: string
          enum:
          - BLOCKER
          - WARN
          - INFO
        code:
          type: string
        title:
          type: string
        summary:
          type: string
        evidence:
          type: object
          required:
          - ranges
          properties:
            ranges:
              type: array
              items:
                type: array
                minItems: 2
                maxItems: 2
                items:
                  type: number
            notes:
              type: string
        stats:
          type: object
          additionalProperties: true
        tags:
          type: array
          items:
            type: string
        charts:
          type: array
          items:
            type: string
        actions:
          type: array
          items:
            type: object
            required:
            - type
            - priority
            - text
            properties:
              type:
                type: string
              priority:
                type: integer
              text:
                type: string
    DiffSetGenerateRequest:
      type: object
      required:
      - runId
      - generator
      properties:
        runId:
          type: string
          format: uuid
        generator:
          type: string
          enum:
          - GM_LS_MAF_V1
        options:
          type: object
          additionalProperties: true
    DiffSetSummary:
      type: object
      required:
      - diffSetId
      - runId
      - name
      - createdAt
      - itemCounts
      properties:
        diffSetId:
          type: string
          format: uuid
        runId:
          type: string
          format: uuid
        name:
          type: string
        source:
          type:
          - string
          - 'null'
        createdAt:
          type:
          - string
          - 'null'
          format: date-time
        itemCounts:
          type: object
          required:
          - total
          - approved
          - suggested
          - rejected
          properties:
            total:
              type: integer
            approved:
              type: integer
            suggested:
              type: integer
            rejected:
              type: integer
    DiffSet:
      type: object
      required:
      - diffSetId
      - name
      - items
      properties:
        diffSetId:
          type: string
          format: uuid
        jobId:
          type:
          - string
          - 'null'
        runId:
          type:
          - string
          - 'null'
        name:
          type: string
        source:
          type:
          - string
          - 'null'
        createdAt:
          type:
          - string
          - 'null'
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/DiffItem'
        diagnostics:
          type: object
          additionalProperties: true
    DiffItem:
      type: object
      required:
      - itemId
      - type
      - path
      - coordinates
      - valueMode
      - units
      - after
      - status
      properties:
        itemId:
          type: integer
        type:
          type: string
          enum:
          - CURVE_POINT
        path:
          type: string
        coordinates:
          type: object
          required:
          - x
          properties:
            x:
              type: number
            y:
              type:
              - number
              - 'null'
        valueMode:
          type: string
          enum:
          - MULTIPLIER
        before: {}
        after:
          type: number
        units:
          type: string
          enum:
          - multiplier
        confidence:
          type: number
          minimum: 0
          maximum: 1
        reason:
          type: string
        applyNotes:
          type: string
        status:
          type: string
          enum:
          - APPROVED
          - SUGGESTED
          - REJECTED
          - APPROVED_OVERRIDE
        tags:
          type: array
          items:
            type: string
    ExportSummaryResponse:
      type: object
      required:
      - text
      properties:
        text:
          type: string
    ExportCsvRequest:
      type: object
      properties:
        includeSuggested:
          type: boolean
          default: false
        minConfidence:
          type: number
          minimum: 0
          maximum: 1
          default: 0.45
    User:
      type: object
      required:
      - id
      - email
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
    AuthStartRequest:
      type: object
      required:
      - email
      properties:
        email:
          type: string
    AuthStartResponse:
      type: object
      required:
      - ok
      properties:
        ok:
          type: boolean
    AuthVerifyRequest:
      type: object
      required:
      - token
      properties:
        token:
          type: string
    AuthVerifyResponse:
      type: object
      required:
      - user
      properties:
        user:
          $ref: '#/components/schemas/User'
    Job:
      type: object
      required:
      - id
      - service_type
      - platform
      - status
      - created_at
      - user_id
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        service_type:
          type: string
        platform:
          type: string
        engine_family:
          type:
          - string
          - 'null'
        vehicle:
          type:
          - string
          - 'null'
        ecu:
          type:
          - string
          - 'null'
        notes:
          type:
          - string
          - 'null'
        status:
          type: string
        created_at:
          type: string
    CreateJobRequest:
      type: object
      required:
      - serviceType
      - platform
      properties:
        serviceType:
          type: string
        platform:
          type: string
        engineFamily:
          type: string
        vehicle:
          type: string
        ecu:
          type: string
        notes:
          type: string
    Upload:
      type: object
      properties:
        id:
          type: string
          format: uuid
        filename:
          type: string
        size_bytes:
          type: integer
  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: dd84_session
